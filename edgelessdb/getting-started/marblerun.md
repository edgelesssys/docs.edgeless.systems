# Running EdgelessDB under MarbleRun

If you want to run EdgelessDB as a distributed application in a confidential cluster, you can combine it with [MarbleRun](https://marblerun.sh).

## Changes
When you are running EdgelessDB as a Marble, it will work slightly different. Rather than generating an encryption key based on the SGX sealing key, MarbleRun will have to provide a key and a root certificate which EdgelessDB can use to sign its own ones. Ideally, you can use MarbleRun's [Secrets management](https://docs.edgeless.systems/marblerun/#/content/features/secrets-management) to accomplish this. Given now MarbleRun will handle EdgelessDB's certificate and key management, Recovery will be unavailable, as it is expected that this is handled on MarbleRun's level for the whole cluster and not just for a single EdgelessDB instance.

## Setup
### Launch the MarbleRun Coordinator
Setup and launch the MarbleRun Coordinator by following the [quickstart guide](https://docs.edgeless.systems/marblerun/#/content/getting-started/quickstart) until Step 3. Alternatively, you can run the Coordinator without Kubernetes by following the [standalone deployment guide](https://docs.edgeless.systems/marblerun/#/content/deployment/standalone) until it is waiting for a manifest to be uploaded.

### Deploy the manifest
You can use the [example MarbleRun manifest from the repository](https://github.com/edgelesssys/edgelessdb/blob/main/demo/marblerun-manifest.json) to see how a minimal configuration could look like.

It is important that the root certificate defined as a secret has the `IsCA` setting set to `true`. Also, it is recommended to set a field such as `Organization` specifically for the root certificate as it helps preventing Common Name (CN) clashes with the certificates generated by EdgelessDB, which usually only define `CommonName` and `DNSNames` derived from the root certificate.

You can define additional EdgelessDB settings by setting the according environment variables from [Configuration](../reference/config.md) in `Env`.

## Launch as a Marble
To run EdgelessDB as a Marble, you have to add `-marble` as a parameter and define the required Marble definitions as environment variables. Assuming you are using the default settings for the MarbleRun coordinator deployed with the example manifest shown above, you can do this in the following way:

```sh
docker run \
--name my-edb \
--privileged \
--network host \
-p3306:3306 \
-p8080:8080 \
-e EDG_MARBLE_TYPE=edb-sample \
-e EDG_MARBLE_COORDINATOR_ADDR=localhost:2001 \
-e EDG_MARBLE_UUID_FILE=uuid \
-e EDG_MARBLE_DNS_NAMES=localhost \
-v /dev/sgx:/dev/sgx \
-t ghcr.io/edgelesssys/edgelessdb-sgx-1gb \
-marble
```

!> The example command uses `--network host` to simplify the required network configuration to discover the coordinator. **This is not necessarily safe for production**, as this disables Docker's network isolation. For production use, please configure adequately such that the EdgelessDB container is able to access the MarbleRun coordinator.


For 4 GB of enclave heap memory, replace `edgelessdb-sgx-1gb` with `edgelessdb-sgx-4gb`.

## Remote attestation
When running as a Marble, you can either attest an EdgelessDB instance by itself as running standalone, or also by attesting the whole cluster once through the MarbleRun Coordinator. Given that EdgelessDB's certificates are issued and provided by MarbleRun, you can establish trust all the down from the whole cluster to the single EdgelessDB instances themselves.
